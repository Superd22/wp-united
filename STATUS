Lots to do, lots to do
--------------

v0.9:


----
coming back to dev after very long hiatus. Major new issues are:
----

On home dev machine, 500 server error causes massive retry loop, [fixed]

connect button disappears after changing path [fixed]












--------------------------------------------------------------------


--- bi-directional user integration------

-- Janrain is incompatible with wp-load bypass ---- simply need to comment out pluggable.php loader

-- create generic WP -> phpbb profile importer (or bi-di profile reconciler)
-- phpBB user creation in settings panel: export WP profile details to phpBB
-- move settings-panel user operations to login-integrator

-- refactor: make use of wpu_get_integration_id and wpu_get_integrated_phpbbuser() wherever possible

-- remove do_logout function (and from install.xml), use hook detection instead
-- add wordpress logout function to log out of phpBB, then remove all login/logout redirects form WP
-- on logout of phpBB find way to clear WP cookies without invoking WP (for new compatibility layer)

-- need to rely on meta:phpbb_userid for bidirectional login to be efficient; rework code to rely on it
-- ensure phpbb_userLogin and userId are removed whever user integration is broken.
-- disable all mapper buttons if an action affects the current user
-- add bi-di functions to phpBB to override session creation (use auth module for login that redirects to phpBB's auth module if necessary !)
-- stop enforcing roles. Trust pre-existing roles -- this way, we avoid tug-of-war in a bi-di setup
-- add options bi-di (default), phpbb->wp, wp->phpbb, explain implications (e.g. COPPA users, spam, etc.)
-- if bi-di, add option to force users to register on the forum, (enabled by default ?)
-- add warning to settings-panel if WP & phpBB cookie domains or paths do not overlap
-- Add warning to ACP if bi-di integ is on but new users won't be integrated due to perms problems (use new wpu_assess_perms)

- $H$/$P$ substitution can take place in hasher override -- no need to do elsewhere. Can check password hashed here, no need to use define (with bi-di, should be able to remove password hash override altogether)		
- Check wp_check_password override!


-- warn about unsuitable admin mappings
-- use new algorithm for identifying potential usermapper mappings: weight e-mail higher than username
-- add 2 new columns to users table -- "wp_username" (Fill it in if the username in WP is different) and use_wp_username (whether to use the WP username when logging in). Add WP usermeta use_phpbbLogin
-- add global option -- which username to use by default if different in phpBB & WordPress. Can be overridden for individual users via the user mapper
-- add check and panel warning if "allow wordpress registrations?" but wpu_can_phpbb_register not true
-- add user_activated check to wordpress? if so check how it behaves
-- add warning / initial integrate admin user and "should disable site" dialog when enabling / disabling user integration

-- map custom WP roles to phpBB perms. (consider: When roles are changed, phpBB is updated?)

-- re-implement phpbb logout, add wp logout override, allow WP profile editing, and re-implement bi-di profile transfers.

-- clean out all link rewrite cruft from plugin and template-integrator -- they are no longer needed. (message on wp-register if disabled or rewrite/redirect?)

- move wp_change_username somewhere better
- consider manually doing make_clickable() on xposted comment text

- Creating a user in phpBB in usermapper does not sync profiles wp-> phpBB yet. First write generic sync function to use


------ cross-posting and comments ---------
-- Add cross-posting permissions to an additional column in the permissions tab (?)
-- move cross-posting from per-topic to per-post (and topic!) to reduce query load
-- check excerpt/full settings are working
-- rework html-to-bbcode translation for images with captions

-- make wpu_get_xposted_details() cachable, and implement a get_topic_url template tag. See http://www.wp-united.com/viewtopic.php?f=9&t=2861 .

-- for each cross-posted comment insert a ghost comment into wordpress with a marker to the phpBB comment (? -- unless we can cleanly generate "comments list to load", see below)
-- override all WP comment loaders (e.g. including in ACP) to merge latest WP posts and phpBB comments into single array
-- consider allowing guest posting of comments (IF akismet is installed?).


----- panel general --------
-- once settings panels are ready, split into separate files in subfolder
-- re-implement "debug info to post" panel -- combine with debug class. Remove lDebug, change to wpuDebug and change in options.php
-- check all defaults -- ensure all options disabled by default (different from v0.8x defaults!)
-- add plugin activate action that describes next steps in bubble
-- integrate phpBB ACP link into dashboard dropdown & menu
-- add plugin deactivate action that warns of consequences, and asks if they want a complete removal.
-- add deinstallation routine using ajax front-end so it can't crash out

---- general cleanup ----
-- settings defaults should all be in one place
-- append_sid is requiring to be fed the session ID -- why?
-- several old links where & should be &amp; -- run through validator
-- do check on plugin activation for php4 and wordpress version
-- when connecting to phpBB, check version for compatibility
-- modify version.php to contain compatibility information
-- Completely rewrite hook, and combine integrator and template-integrator, since they are now the same
-- re-base file structure so phpBB mod sits under plugin
-- split plugin files into folders -- e.g. split off settings panel
-- move wp-integration-class into general parser class that can be used by both P & W and plugin fixers
-- remove global checker from plugin fixers, and get them to check for new WP3 syntax -- consider removing altogether
-- consider lightening phpBB & WP load by removing unneeded functions in WP & phpBB.
-- consider only loading phpBB if user needs to integrate and they aren't logged in, if this is a cross-post or if widgets need it -- e.g. bootstrap_phpbb (as we did in v0.7x)
-- use common-lite.php for phpBB to remove unneeded options in admin (and potentially on WP pages).
-- LANG strings -- move back again to WP po/mo (arrgh - we ported them to phpBB in v0.8!)

- make_clickable removal still needs to run on rev int pages!

-- check for caching plugin, esp. total cache & super cache, and check that they are handling phpBB cookie and not causing errors
-- remove 90% of all defines, clean up unused globals
-- remove all old user blog options (e.g. split uploads, etc.)
-- check all function arbitration is still working, use dynamic args if needed
-- remove legacy backwards-compat paths, clean up old TODOs


----- template integration ------------
-- update css magic to work with subdomains
-- re-evaluate parsing of inline css with tVoodoo: performance hit may not be worth it
-- get acp login page to integrate too -- otherwise looks bad if user removes header/footer
-- auto-clear of template cache when nav settings changed in WP3
-- re-enable wordpress-in-phpbb intetgration
-- When grepping <title>, check if more than one exists. If so, ignore any commented ones.

---- widgets --------
-- finish moving widgets from widgets1 to widgets2
-- add username colours to topics, posts & loginuserinfo widget
-- login can use ajax->refresh with bidi integration (but still logs into phpBB)
-- other widget suggestions from forum
-- include gpl userblog widgets
-- Add forum selection/deselection option to widget control panel for latest posts and topics widgets


-------- user blogs --> wp-ms ----------
-- check we don't crash out on WP-ms load
-- check permissions mapping and user creation -- add check for whether they should be given a blog or not when being created
-- check css magic / template voodoo with many different user blog templates at once. (or disallow/warn against wordpress-in-phpbb with wp-ms)
-- add back userblog permissions
-- reconnect blog buttons, consider removing blogid from phpBB


--------- possible ---------------
-- Add user lookup to permissions mapping tab
-- Add AutoMod engine (may defer to v0.9.x > .0 if not trivial)
-- Add pre-mod routines and scratch/plugins loader folder for plugins or premium options
-- Finish "advanced settings" panel page -- first see what options are around and whether still necessary
-- Override WP version check?
-- support custom post types with per-type cross-posting settings
-- add ability to send settings to WP-United.com for analysis/feedback (likely deferred til 1.0)
-- check that we at least load up with Buddypress


------- pie in the sky -----------
-- draggable permissions mapping using e.g. jsPlumb
-- finish "post to blog" in phpBB, integrate with pressIt
-- search integration
-- split pane help panel popup with all strings pre-loaded (definitely need for v1.0)


--------- v0.8x -> v0.9.0 migrator / upgrader --------------

In order to ensure a clean break and new features and code, work on this is deferred until we have a solid v0.9x
Once that is ready to release, we need a migrator that can:

- run in phpBB and compile a list of actions before any settings are overwritten (or before files are changed in case they get errors)
- remove old settings in WP & phpBB
- remove old widget options
- remove a_wpu_manage permission
- remove ACP modules
- add new user table columns
- ensure meta::phpbb_userId and phpbb_userLogin exists for all integrated users, and not for unintegrated users
- migrate cross-posts to post marker system
- create ghost posts for cross-posted comments (if needed)
- auto-create wp-ms blogs for users with own blogs and move posts into them
- check for old files that should be deleted
- provide instructions for moving from blog.php to new system (or auto-detect the settings)




Other (older) things noticed that may no longer be relevant
---------------------

- Last post time reported different from topic time
- Cross-posted post reported not read, even after reading
- $_SERVER['DOCUMENT_ROOT'] unreliable as source for path computation on open_basedir restricted servers
- ? author permalinks not working if author permalink with space in username
- wpu_get_xposted_details called multiple times on page view (comments_open, comment load). Result should be cached.
- Check "posts since last visit" algorithm


Fixed/Committed for vNext. For all changed prior to v0.9, see changelog
------------------------------------

Check that function update_option exists when installing connection -- if not, balk
Internalising of integrated login into wordpress -- in progress
- search for all $wpUtdInt->integrate_logins and remove (done)
- Remove reliance on overridden wp functions: (DONE)
	-- move hasher to login-integrator (done)
			- instead of multiple defines, set once (reduced as much as possible)
			- check that hasher override overrides in time. (done, moved)
			- remove registration.php stuff from wp-functions. (done) HOWEVER: need to handle validate_username conflict
					- Can just rename phpBB's validate_username if a marker is set (done)
	-- kill make_clickable from wp-functions: rename it in phpBB and add alias function if not defined. (done)
	Login debug moved to new generic debugger class
- Set define (WPU_DISABLE_LOGIN_INT) for bypassing integrated login -- we don't want it to happen in user mapper, etc. 
- Removed blog.php, blogsUri option
- forward template integration now works again without blog.php
- Fixed absolute phpbb_root_path breaks phpBB URLs in forward template integration
- wordpress now always run in global scope for reverse integration (but header/footer called locally)
- Moved ACP panel to wordpress. Settings not yet transferred --need to repackage mod and transfer over settings
- settings now being transferred to phpBB.
- Mod-settings in phpBB is now simplified into a single array getter/setter
- Settings and style-keys now got and set all at once to prevent partial loads
- phpBB now invoked from wordpress via override of get_currentuser -- everything inited in simple flow (with exception of reverse integration)
- settings panel checks for conflicting overrides in other plugins, for PHP errors that happenned previously, or for phpBB's debug being set, and shows appropriate warnings
- Sophisticated AJAX front-end for enabling/disabling and processing settings now added
- User integration completely rewritten and significantly simplified -- we no longer check for outside use-case mis-mappings, and just get on with it
- No longer log out non-integrated users -- assume people who are already logged in are supposed to be so. This allows us to to bi-directional user integration with phpBB
- New function wpu_assess_perms() in login-integrator for resolving WP-United permissions for user groups.
- wpu_assess_newuser_perms() is a new helper function -- can determine whether a new user in phpBB would be "integratable". Useful for bi-directional user integration
- Updated wpu_assess_perms() to pull relevant info in panel and in normal use
- Updated Permissions tab in user mapping -- it now shows effective permissions or 'Never' settings
- Permissions mapping tab now has deep links into ACP in nice colourbox popup, and updates live on changes.
- New deep link to phpBB ACP in wp-united dashboard menu
- Cleaned up $phpbbForum class (now PHP 5 only)
- $phpbbForum->enter() and leave() are now private. Access to phpBB is through $phpbbForum->foreground(), ->background() and restore_state($state)
- dynamic usermapper now implemented. Can't yet perform actions (in progress)
- re-instituted validate_username_conflict
- added bulk actions to user mapper.
- added all actions to user mapper
...
- new helper functions, wpu_get_integration_id (updated to take optional userID) and wpu_get_integrated_phpbbuser() to determine mapped status
- new phpBB user gets created and integrated when WordPress user is registered. Tested with RPX.
- phpBB  user is logged out when wordpress logs out
- wordpress user is logged out when phpBB logs out


... for phpbb-side login ideas.....

/**** for later...	registering
 * $GLOBALS['skip_add_log'] = true;
	// Which group by default?
	$group_name = 'REGISTERED';

	$sql = 'SELECT group_id
		FROM ' . GROUPS_TABLE . "
		WHERE group_name = '" . $db->sql_escape($group_name) . "'
			AND group_type = " . GROUP_SPECIAL;
	$result = $db->sql_query($sql);
	$row = $db->sql_fetchrow($result);
	$db->sql_freeresult($result);
if (!$row)
				{
					trigger_error('NO_GROUP');
				}

				$group_id = $row['group_id'];	
	
	
	$user_row = array(
		'username'				=> $data['username'],
		'user_password'			=> phpbb_hash($data['new_password']),
		'user_email'			=> $data['email'],
		'group_id'				=> (int) $group_id,
		'user_type'				=> USER_NORMAL,
		'user_ip'				=>  'optional -- see auth.php',
		'user_regdate'			=> 'optional -- see auth.php',
		'new_user'				=> 'set to 1 if user s/b added to new user group, else 0.'
		
	);
	
****/	








Current prog flow:

- p in w:
:: wp starts, calls phpBB early
:: phpbb runs
::: phpbb hook invoked
::: buffering started on user_session_handler hook
::: prohibit template display, catch content and display on template->display hook

how this should work:

w in p
:: wp starts, 
:: sets PHPBB_DB_NEW_LINK
:: calls phpBB early (for login int)
:: buffering starts
:: set exception handler

in phpbb exit handler hook:
throw new PhpBB_Exited_Exception('phpBB exited.');

in wp:
try
{
    call_phpbb();
}
catch (PhpBB_Exited_Exception $e) {}
// continue with wp here
